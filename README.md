
# Project Documentation: YouPass RBAC Application

## 1. Introduction


### 1.1. Core Purpose:

To manage users and their permissions within an application through a system of roles.

### 1.2. Key Features:

-   User Authentication (Login/Logout)
-   User Management (CRUD operations for users)
-   Role Management (CRUD operations for roles)
-   Permission Management (Assigning permissions to roles, viewing permissions)
-   Role-Based Access Control for UI elements and API routes.

### 1.3. Technology Stack:

-   **Frontend:** Angular, Angular Material, SCSS
-   **Backend:** Node.js, Express.js. 
	* *I am aware that the task asked to use JSON Server, but I found it did not provide the kind of sophistication needed for the project. Existing wrapper packages for authentication also seemed outdated*
-   **Database:** JSON file (`db.json`) for simplicity
-   **Authentication:** JWT (JSON Web Tokens)

## 2. Getting Started

### 2.1. Prerequisites:

-   Node.js (v22.x or later)
-   npm 
-   Angular CLI (@angular/cli, v19.x)
-   Git 

### 2.2. Installation:
 *The Frontend and Backend will be kept in separate directories, but have been kept together for this task project*
 
-   **Backend (`server.js`) and Frontend (Angular Application)**
    1.  Clone the repository.
    2.  Navigate to the root directory (where `server.js` and `package.json` for the server are located).
    3.  Install dependencies: `npm install`

### 2.3. Configuration:

-   **Backend:**
    -   `PORT` (currently `3001` in `server.js`)
-   **Frontend:**
    -   API URL (`environment.ts` and `environment.prod.ts` for `apiUrl`)

### 2.4. Running the Application:

-   **Backend:**
    1.  Navigate to the server directory.
    2.  Start the server: `node server.js` 
    3.  The server will typically run on [http://localhost:3001](https://www.google.com/search?q=http://localhost:3001).
-   **Frontend:**
    1.  On another terminal tab, navigate to the Angular project directory.
    2.  Start the development server: `ng serve` or `npm start`
    3.  The application will typically be accessible at [http://localhost:4200](https://www.google.com/search?q=http://localhost:4200).

### 2.5. Credentials

Use the following credentials to log into the application:

    UserName: superadmin
    Password: superadmin

Similarly, you can also use the following credentials for a more limited access level:

    UserName: johndoe
    Password: johndoe

## 3. Project Structure

### 3.1. Backend (Node.js/Express - `server.js`):

-   `server.js`: Main application file containing Express server setup, middleware, API routes, and logic for interacting with `db.json`.
-   `db.json`: Simple JSON file acting as the database for users, roles, and permissions.
-   **Key Modules Used:** `express`, `jsonwebtoken`, `bcrypt`, `fs`, `path`, `cors`.

### 3.2. Frontend (Angular):
*Please ignore the spec files within the project. They were auto-generated by the Angular CLI and have been kept as they are.*
-   `src/app/`:
    -   `core/`: Core modules, services, and guards.
        -   `guards/`: Protects routes based on authentication/authorization status. Two of the guards use different implementations (using directly through a function, and a class-based implementation). This is simply to show the many ways this could be done.
        -   `services/local-storage.service.ts`: Handles interaction with browser's local storage.
        - Similarly, we have `pipes`, custom `validators`, and other stuff within here.
    -   `features/`: Feature-specific modules/components.
        -   `auth/`: Authentication related components and services.
            -   `login/components/login.component.ts` (`.html`, `.scss`): Login page UI and logic.
            -   `services/auth.service.ts`: Handles authentication logic, API calls, and user state.
        -   `home/`: Main layout component after login.
            -   `home.component.ts` (`.html`, `.scss`): Contains the main structure with navbar and sidebar.
        -   `landing/`: Landing page component.
        -   `page-not-found/`: Page Not Found component.
        -   `role-management/`: Components and services for managing roles.
            -   `components/role-details/role-details.component.ts` (`.html`, `.scss`): Displays details of a specific role.
            -   _(Other components like `role-list`, `role-form` would be here)_
        -   `user-management/`: Components and services for managing users.
            -   `components/user-details/user-details.component.ts` (`.html`, `.scss`): Displays details of a specific user.
            -   `components/user-form/user-form.component.ts` (`.html`, `.scss`): Form for creating/editing users.
            -   `components/user-management/user-management.component.ts` (`.html`, `.scss`): Lists users and provides management actions.
            -   `services/user.service.ts`: Handles user-related API calls.
    -   `shared/`: Reusable components
        -   `components/navbar/navbar.component.ts` (`.html`, `.scss`): Application's top navigation bar.
        -   `components/sidebar/sidebar.component.ts` (`.html`, `.scss`): Application's side navigation menu.
        -   `components/confirmation-dialog/`: Reusable dialog for confirmations.
    -   `assets/`: Static assets like images.
    -   `environments/`: Environment-specific configurations (e.g., API URL).
    -   `app-routing.module.ts`: Main application routing configuration.
    -   `app.component.ts` (`.html`, `.scss`): Root component of the application.
    -   `styles.scss`: Global styles.

## 4. Backend API (`server.js`)

### 4.1. Authentication Middleware (`authenticateToken`):

-   Verifies JWT token from the `Authorization` header.
-   Protects API routes that require authentication.

### 4.2. Authentication Endpoint:

-   `POST /login`: Authenticates a user based on username and password.
    -   Compares hashed password.
    -   Returns JWT `accessToken` and `user` object (with permissions flattened).

### 4.3. User Management Endpoints (all prefixed with `/api` and require authentication):

-   `GET /users`: Get all users (passwords are omitted).
-   `GET /users/:username`: Get a specific user by username (password omitted).
-   `POST /users`: Add a new user. Hashes password before saving.
-   `PUT /users/:username`: Edit an existing user. Can update password (hashes if provided).
-   `DELETE /users/:username`: Delete a user.

### 4.4. Role Management Endpoints (all prefixed with `/api` and require authentication):

-   `GET /roles`: Get all roles.
-   `GET /roles/:name`: Get a specific role by name.
-   `POST /roles`: Add a new role.
-   `PUT /roles/:name`: Edit an existing role.
-   `DELETE /roles/:name`: Delete a role. Prevents deletion if users are assigned to the role.

### 4.5. Permission Management Endpoints (prefixed with `/api` and require authentication):

-   `GET /permissions`: Get all available permissions.

### 4.6. Data Handling:

-   `readDatabase()`: Helper function to read `db.json`.
-   `writeDatabase()`: Helper function to write to `db.json`.

## 5. Frontend Architecture (Angular)

### 5.1. Core Concepts:

-   **Components:** Building blocks of the UI (e.g., `LoginComponent`, `NavbarComponent`). Most are standalone.
-   **Services:** Encapsulate business logic, API calls, and shared state (e.g., `AuthService`, `UserService`, `LocalStorageService`).
-   **Routing:** Defined in `app-routing.module.ts`, manages navigation between different views/components.
-   **Guards (`AuthGuard`):** Protects routes, ensuring only authenticated users can access certain parts of the application.
-   **Models/Interfaces** (`User`, `ExtendedUser`, `Role`, etc.): Define data structures.
-   **Angular Material:** Used extensively for UI components (buttons, cards, tables, dialogs, icons, toolbar, sidenav, etc.).
-   **Reactive Forms:** Used for forms like login and user creation/editing.
-   **RxJS:** Used for handling asynchronous operations and managing state with `BehaviorSubject` and `Observable`.

### 5.2. State Management:

-   Primarily managed within services using `BehaviorSubject` to provide observable streams of data (e.g., `isAuthenticated$`, `loggedInUser$` in `AuthService`, `userList$` in `UserService`).
-   `shareReplay()` is used to share observable streams efficiently.

### 5.3. Styling:

-   Global styles in `styles.scss`.
-   Component-specific styles in their respective `.scss` files.
-   Leverages Angular Material's theming capabilities.

### 5.4. Key Workflows:

-   **Login:** User enters credentials -> `LoginComponent` calls `AuthService.login()` -> `AuthService` makes API call -> On success, token and user data stored in `LocalStorageService`, `isAuthenticated$` and `loggedInUser$` updated -> User redirected.
-   **Logout:** `NavbarComponent` calls `AuthService.logout()` -> Token and user data cleared from `LocalStorageService`, `isAuthenticated$` updated -> User redirected to login.
-   **Displaying User/Role Lists:** Component (`UserManagementComponent`) subscribes to service observable (`UserService.userList$`) -> Service fetches data from API -> Table is rendered.
-   **CRUD Operations (User/Role):**
    -   User clicks "Add" or "Edit" -> `MatDialog` opens form component (`UserFormComponent`).
    -   User submits form -> Form component calls respective service method.
    -   Service makes API call.
    -   On success, list is updated (often by re-fetching or updating the `BehaviorSubject`).
    -   User clicks "Delete" -> Confirmation dialog shown -> On confirm, service makes API call.
-   **Route Protection:** `AuthGuard` checks `AuthService.isAuthenticated$` before allowing navigation to protected routes. If not authenticated, redirects to `/login`.
-   **Permission-Based UI:**
    -   Sidebar links (`SidebarComponent`) are conditionally shown based on `loggedInUser$.role`.
    -   Actions within components (e.g., "Add User" button in `UserManagementComponent`) are conditionally enabled/disabled based on `loggedInUserPermissionsBoolean` derived from `loggedInUser.permissions`.

## 6. UI Components & Styling Overview
*I tried to make use of an existing template for the UI, so it would speed up the prototyping. Angular's latest version (was v19.x when the project was given, and a new v20.x is now available in these last few days, so hurray on that!) has some differences with the templates available on the market, which often rely on old Angular/Material versions. I briefly considered using the Flowbite library along with TailwindCSS, but there seemed to be either lot of conflicts with Material, or a lot of the work was abstracted away, and the code became increasingly unreadable. In the end, I settled for Material with SCSS. A lot of the SCSS code you see here has been pulled from other projects. Given the time frame, my major focus has been on the correctness of the functionality over a sleeker UI. Still, I may have missed a few points, which I am hoping you won't hold against my candidacy.*

### 6.1. Overall Layout (`home.component.html`):

-   Uses `<mat-sidenav-container>` with a fixed navbar (`app-navbar`) and a side navigation panel (`app-sidebar`).
-   `fixedTopGap` on `<mat-sidenav>` ensures it's positioned below the navbar.
-   Main content is rendered via `<router-outlet>` in `<mat-sidenav-content>`.

### 6.2. Navbar (`navbar.component.html`, `.scss`):

-   Displays application logo and name.
-   Includes a "Logout" button.
-   Styled with custom SCSS and `<mat-toolbar>`.

### 6.3. Sidebar (`sidebar.component.html`, `.scss`):

-   Uses `<mat-nav-list>` and `<mat-list-item>` for navigation links.
-   Links are conditionally displayed (e.g., "Role management" for superadmin).
-   `routerLinkActive` is used to highlight the active navigation item.

### 6.4. Forms (e.g., `login.component.html`, `user-form.component.html`):

-   Utilize `<mat-card>` for structure.
-   Employ `<mat-form-field>`, `<mat-label>`, `<matInput>`, `<mat-error>` for input fields and validation messages.
-   `<mat-button>` for submission.

### 6.5. Detail Views (e.g., `user-details.component.html`, `role-details.component.html`):

-   Use `<mat-card>` with `<mat-card-header>`, `<mat-card-content>`, and `<mat-card-actions>`.
-   Display information in a structured way, often using `<mat-icon>` and `<mat-chip-set>` (for permissions).

### 6.6. Tables (e.g., `user-management.component.html`):

-   Uses `<mat-table>` to display lists of data.
-   Includes action menus (`mat-menu`) for each row.

### 6.7. Dialogs:

-   `MatDialog` is used for forms (add/edit) and confirmation messages.

## 7. Error Handling

### 7.1. Backend:

Sends appropriate HTTP status codes (400, 401, 403, 404, 409, 500) and messages.

### 7.2. Frontend:

-   Form validation messages displayed using `<mat-error>`.
-   `MatSnackBar` used for brief success/error notifications after operations.
-   `PageNotFoundComponent` for undefined routes.

## 8. Security Considerations

### 8.1. Password Hashing:

`bcrypt` is used on the backend to hash passwords before storing.

### 8.2. JWT Authentication:

Protects API endpoints.

### 8.3. CORS:

Configured on the backend to allow requests from the Angular frontend's origin.

### 8.4. Input Validation:

Basic validation on backend for required fields. Frontend uses reactive form validators.

### 8.5. Frontend Route Protection:

`AuthGuard` prevents unauthorized access to client-side routes.
